# Apache Flink ä½¿ç”¨è¯´æ˜ä¸åŸç†è¯¦è§£

## ğŸ“š ç›®å½•

1. [Flink ç®€ä»‹](#1-flink-ç®€ä»‹)
2. [Flink æ ¸å¿ƒèƒ½åŠ›](#2-flink-æ ¸å¿ƒèƒ½åŠ›)
3. [å®é™…åº”ç”¨åœºæ™¯](#3-å®é™…åº”ç”¨åœºæ™¯)
4. [Flink vs æ™®é€šç¨‹åºå¯¹æ¯”](#4-flink-vs-æ™®é€šç¨‹åºå¯¹æ¯”)
5. [æ•…éšœæ¢å¤æœºåˆ¶è¯¦è§£](#5-æ•…éšœæ¢å¤æœºåˆ¶è¯¦è§£)
6. [å¢é‡æ›´æ–°åŸç†](#6-å¢é‡æ›´æ–°åŸç†)
7. [ClkLog é¡¹ç›®ä¸­çš„ Flink åˆ†æ](#7-clklog-é¡¹ç›®ä¸­çš„-flink-åˆ†æ)
8. [æ˜¯å¦éœ€è¦ä½¿ç”¨ Flink](#8-æ˜¯å¦éœ€è¦ä½¿ç”¨-flink)

---

## 1. Flink ç®€ä»‹

### 1.1 ä»€ä¹ˆæ˜¯ Flinkï¼Ÿ

Apache Flink æ˜¯ä¸€ä¸ª**åˆ†å¸ƒå¼æµå¤„ç†å¼•æ“**ï¼Œç”¨äºå¤„ç†**æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµ**ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- âœ… **å®æ—¶æµå¤„ç†**ï¼šæ¯«ç§’çº§å»¶è¿Ÿ
- âœ… **æœ‰çŠ¶æ€è®¡ç®—**ï¼šè®°ä½å†å²æ•°æ®
- âœ… **ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰**ï¼šæ•°æ®ä¸é‡ä¸æ¼
- âœ… **åˆ†å¸ƒå¼**ï¼šæ”¯æŒå¤§è§„æ¨¡æ•°æ®å¤„ç†
- âœ… **å®¹é”™æœºåˆ¶**ï¼šè‡ªåŠ¨æ•…éšœæ¢å¤

### 1.2 Flink èƒ½åšä»€ä¹ˆï¼Ÿ

```
å®æ—¶æ•°æ®æµ â†’ Flink â†’ å®æ—¶ç»“æœ
    â†“
å¤„ç†ï¼šè¿‡æ»¤ã€è½¬æ¢ã€èšåˆã€å…³è”ã€çª—å£è®¡ç®—
åº”ç”¨ï¼šå®æ—¶ç»Ÿè®¡ã€æ¬ºè¯ˆæ£€æµ‹ã€æ¨èç³»ç»Ÿã€å¤§å±çœ‹æ¿
```

---

## 2. Flink æ ¸å¿ƒèƒ½åŠ›

### 2.1 æœ‰çŠ¶æ€æµå¤„ç†

**ä»€ä¹ˆæ˜¯"çŠ¶æ€"ï¼Ÿ**

çŠ¶æ€å°±æ˜¯ Flink **è®°ä½çš„å†å²æ•°æ®**ã€‚

**ä¾‹å­ï¼šç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è®¿é—®æ¬¡æ•°**

```java
// æ— çŠ¶æ€ï¼šæ¯æ¬¡éƒ½ä» 0 å¼€å§‹
Input: ç”¨æˆ·A, ç”¨æˆ·B, ç”¨æˆ·A
Output: 1, 1, 1  âŒ é”™è¯¯ï¼

// æœ‰çŠ¶æ€ï¼šè®°ä½ä¹‹å‰çš„è®¡æ•°
Input: ç”¨æˆ·A, ç”¨æˆ·B, ç”¨æˆ·A
çŠ¶æ€:   {A:1},  {A:1, B:1},  {A:2, B:1}
Output: 1, 1, 2  âœ… æ­£ç¡®ï¼
```

**Flink çŠ¶æ€ç®¡ç†ï¼š**
```java
KeyedStream<UserEvent, String> stream = env
    .addSource(kafkaSource)
    .keyBy(UserEvent::getUserId)        // æŒ‰ç”¨æˆ· ID åˆ†ç»„
    .process(new KeyedProcessFunction<String, UserEvent, Result>() {
        // æ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„çŠ¶æ€ï¼ˆè®¡æ•°å™¨ï¼‰
        private ValueState<Integer> count;

        @Override
        public void open(Configuration parameters) {
            // åˆå§‹åŒ–çŠ¶æ€
            count = getRuntimeContext().getState(
                new ValueStateDescriptor<>("count", Integer.class)
            );
        }

        @Override
        public void processElement(UserEvent event, Context ctx, Collector<Result> out) {
            // è¯»å–å½“å‰è®¡æ•°
            Integer currentCount = count.value();
            if (currentCount == null) {
                currentCount = 0;
            }

            // æ›´æ–°è®¡æ•°
            currentCount++;
            count.update(currentCount);

            // è¾“å‡ºç»“æœ
            out.collect(new Result(event.getUserId(), currentCount));
        }
    });
```

**ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ï¼Ÿ**
- è®°ä½æ¯ä¸ªç”¨æˆ·çš„å†å²è¡Œä¸º
- è®¡ç®—æ»‘åŠ¨çª—å£ï¼ˆæœ€è¿‘ 5 åˆ†é’Ÿçš„æ•°æ®ï¼‰
- å»é‡ç»Ÿè®¡ï¼ˆUVï¼‰
- ä¼šè¯ç®¡ç†ï¼ˆç”¨æˆ· 30 åˆ†é’Ÿå†…çš„æ“ä½œåºåˆ—ï¼‰

---

### 2.2 çª—å£è®¡ç®—

**ä»€ä¹ˆæ˜¯çª—å£ï¼Ÿ**

å°†æ•°æ®æµæŒ‰æ—¶é—´åˆ‡åˆ†æˆä¸€ä¸ªä¸ª**æ¡¶**ï¼Œæ¯ä¸ªæ¡¶å†…çš„æ•°æ®ä¸€èµ·è®¡ç®—ã€‚

**çª—å£ç±»å‹ï¼š**

#### 1ï¸âƒ£ **æ»šåŠ¨çª—å£ï¼ˆTumbling Windowï¼‰**

```
æ—¶é—´è½´ï¼š0----10----20----30----40----50ç§’
       â†“     â†“     â†“     â†“     â†“
çª—å£1ï¼š  [0-10ç§’çš„æ•°æ®]
çª—å£2ï¼š        [10-20ç§’çš„æ•°æ®]
çª—å£3ï¼š              [20-30ç§’çš„æ•°æ®]
```

**åº”ç”¨ï¼š** æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡é”€é‡

```java
stream
    .window(TumblingProcessingTimeWindows.of(Time.minutes(1)))
    .sum("amount");
```

#### 2ï¸âƒ£ **æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**

```
æ—¶é—´è½´ï¼š0----10----20----30----40----50ç§’
       â†“â†“    â†“â†“    â†“â†“    â†“â†“
çª—å£1ï¼š  [0-10ç§’]
çª—å£2ï¼š    [5-15ç§’]
çª—å£3ï¼š        [10-20ç§’]
```

**åº”ç”¨ï¼š** æ¯ 10 ç§’ç»Ÿè®¡æœ€è¿‘ 1 åˆ†é’Ÿçš„æµé‡

```java
stream
    .window(SlidingProcessingTimeWindows.of(Time.minutes(1), Time.seconds(10)))
    .aggregate(new TrafficCounter());
```

#### 3ï¸âƒ£ **ä¼šè¯çª—å£ï¼ˆSession Windowï¼‰**

```
ç”¨æˆ·A: è®¿é—®1 --30åˆ†é’Ÿæ— æ“ä½œ-- è®¿é—®2 --è®¿é—®3
       â†“ä¼šè¯1â†“                    â†“ä¼šè¯2â†“
```

**åº”ç”¨ï¼š** ç»Ÿè®¡ç”¨æˆ·ä¼šè¯æ—¶é•¿

```java
stream
    .window(EventTimeSessionWindows.withGap(Time.minutes(30)))
    .process(new SessionAnalyzer());
```

---

### 2.3 ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼ˆExactly-Onceï¼‰

**é—®é¢˜ï¼šæ•°æ®é‡å¤æˆ–ä¸¢å¤±**

```
å‘é€ç«¯ï¼šå‘é€æ¶ˆæ¯1, æ¶ˆæ¯2, æ¶ˆæ¯3
       â†“ å´©æºƒ
æ¥æ”¶ç«¯ï¼šæ”¶åˆ°æ¶ˆæ¯1, æ¶ˆæ¯1ï¼ˆé‡å¤ï¼‰, æ¶ˆæ¯3
       âŒ æ•°æ®é‡å¤
```

**Flink çš„è§£å†³æ–¹æ¡ˆï¼šCheckpoint æœºåˆ¶**

```
æ­£å¸¸æµç¨‹ï¼š
æ•°æ®æµå¤„ç† â†’ çŠ¶æ€æ›´æ–° â†’ Checkpointï¼ˆä¿å­˜çŠ¶æ€å¿«ç…§ï¼‰

æ•…éšœå‘ç”Ÿï¼š
å¤„ç†åˆ°æ¶ˆæ¯50 â†’ å´©æºƒ

æ•…éšœæ¢å¤ï¼š
ä»æœ€è¿‘ä¸€æ¬¡ Checkpoint æ¢å¤ï¼ˆæ¯”å¦‚æ¶ˆæ¯40çš„çŠ¶æ€ï¼‰
é‡æ–°å¤„ç†æ¶ˆæ¯41-50
âœ… ä¿è¯æ¯æ¡æ¶ˆæ¯åªå¤„ç†ä¸€æ¬¡
```

**è¯¦ç»†åŸç†è§ç¬¬ 5 èŠ‚ã€‚**

---

### 2.4 åˆ†å¸ƒå¼æ‰§è¡Œ

**å•æœº vs åˆ†å¸ƒå¼ï¼š**

```
å•æœºå¤„ç†ï¼š
1å°æœºå™¨ â†’ å¤„ç† 1ä¸‡æ¡/ç§’

åˆ†å¸ƒå¼å¤„ç†ï¼š
10å°æœºå™¨ â†’ æ¯å°å¤„ç† 1ä¸‡æ¡/ç§’ â†’ æ€»è®¡ 10ä¸‡æ¡/ç§’
```

**Flink è‡ªåŠ¨åˆ†å¸ƒï¼š**

```java
// è®¾ç½®å¹¶è¡Œåº¦
env.setParallelism(10);

// Flink è‡ªåŠ¨å°†ä»»åŠ¡åˆ†é…åˆ° 10 ä¸ªæ§½ä½ï¼ˆSlotï¼‰
Slot 1: å¤„ç†æ•°æ®åˆ†ç‰‡ 1
Slot 2: å¤„ç†æ•°æ®åˆ†ç‰‡ 2
...
Slot 10: å¤„ç†æ•°æ®åˆ†ç‰‡ 10
```

---

### 2.5 å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰

**ä»€ä¹ˆæ˜¯ CEPï¼Ÿ**

æ£€æµ‹äº‹ä»¶æµä¸­çš„**å¤æ‚æ¨¡å¼**ã€‚

**ä¾‹å­ï¼šæ£€æµ‹ç”¨æˆ·è¿ç»­ 3 æ¬¡ç™»å½•å¤±è´¥**

```java
Pattern<LoginEvent, ?> pattern = Pattern.<LoginEvent>begin("fail1")
    .where(evt -> !evt.isSuccess())           // ç¬¬ 1 æ¬¡å¤±è´¥
    .next("fail2")
    .where(evt -> !evt.isSuccess())           // ç¬¬ 2 æ¬¡å¤±è´¥
    .next("fail3")
    .where(evt -> !evt.isSuccess())           // ç¬¬ 3 æ¬¡å¤±è´¥
    .within(Time.minutes(1));                 // 1 åˆ†é’Ÿå†…

// åº”ç”¨æ¨¡å¼åˆ°æ•°æ®æµ
PatternStream<LoginEvent> patternStream = CEP.pattern(stream, pattern);

// æ£€æµ‹åˆ°æ¨¡å¼ï¼Œè§¦å‘å‘Šè­¦
patternStream.select((map) -> {
    System.out.println("æ£€æµ‹åˆ°æš´åŠ›ç ´è§£æ”»å‡»ï¼");
    return map;
});
```

**åº”ç”¨åœºæ™¯ï¼š**
- æ¬ºè¯ˆæ£€æµ‹ï¼ˆå¼‚å¸¸äº¤æ˜“æ¨¡å¼ï¼‰
- é£æ§ï¼ˆè–…ç¾Šæ¯›è¡Œä¸ºï¼‰
- æ¨èç³»ç»Ÿï¼ˆæµè§ˆ â†’ åŠ è´­ â†’ ä¸‹å•ï¼‰

---

## 3. å®é™…åº”ç”¨åœºæ™¯

### 3.1 å®æ—¶ç»Ÿè®¡ç½‘ç«™åœ¨çº¿äººæ•°

**éœ€æ±‚ï¼š** å®æ—¶ç»Ÿè®¡æ¯ä¸ªé¡µé¢çš„åœ¨çº¿äººæ•°ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡

#### âŒ æ–¹æ¡ˆ Aï¼šæ™®é€šç¨‹åº

```java
@Scheduled(fixedDelay = 1000)
public void countOnlineUsers() {
    // æ¯ç§’æ‰«ææ•°æ®åº“
    String sql = "SELECT page_url, COUNT(DISTINCT user_id) " +
                 "FROM log_analysis " +
                 "WHERE time > NOW() - INTERVAL 60 SECOND " +
                 "GROUP BY page_url";

    List<Result> results = jdbcTemplate.query(sql);
}
```

**é—®é¢˜ï¼š**
- âŒ æ¯ç§’æ‰«æç™¾ä¸‡æ¡æ•°æ®ï¼ˆæ…¢ï¼‰
- âŒ æ•°æ®åº“å‹åŠ›å¤§
- âŒ å»¶è¿Ÿé«˜ï¼ˆ5-10 ç§’ï¼‰

#### âœ… æ–¹æ¡ˆ Bï¼šFlink

```java
DataStream<LogEvent> stream = env
    .addSource(new KafkaSource(...))
    .keyBy(LogEvent::getPageUrl)
    .window(TumblingProcessingTimeWindows.of(Time.seconds(60)))
    .aggregate(new CountDistinct());  // å»é‡ç»Ÿè®¡

stream.print();  // æ¯ç§’è¾“å‡ºç»“æœ
```

**ä¼˜åŠ¿ï¼š**
- âœ… å®æ—¶è®¡ç®—ï¼ˆå»¶è¿Ÿ < 1 ç§’ï¼‰
- âœ… å¢é‡è®¡ç®—ï¼Œä¸æ‰«æå…¨è¡¨
- âœ… è‡ªåŠ¨å®¹é”™

---

### 3.2 æ£€æµ‹æ¬ºè¯ˆäº¤æ˜“

**éœ€æ±‚ï¼š** æ£€æµ‹ 1 åˆ†é’Ÿå†…è¿ç»­ 3 æ¬¡å¯†ç é”™è¯¯çš„ç™»å½•

#### âŒ æ–¹æ¡ˆ Aï¼šæ™®é€šç¨‹åº

```java
public void checkLogin(String userId, boolean success) {
    if (!success) {
        // æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
        String sql = "SELECT COUNT(*) FROM login_log " +
                     "WHERE user_id = ? " +
                     "AND success = false " +
                     "AND time > NOW() - INTERVAL 1 MINUTE";

        int count = jdbcTemplate.queryForObject(sql, Integer.class, userId);

        if (count >= 3) {
            lockAccount(userId);
        }
    }
}
```

**é—®é¢˜ï¼š**
- âŒ æ¯æ¬¡ç™»å½•éƒ½æŸ¥æ•°æ®åº“ï¼ˆæ…¢ï¼‰
- âŒ å¹¶å‘é«˜æ—¶æ•°æ®åº“æ‰›ä¸ä½
- âŒ ç¬¬ 3 æ¬¡æ‰æ£€æµ‹åˆ°ï¼Œæ— æ³•é¢„è­¦

#### âœ… æ–¹æ¡ˆ Bï¼šFlink CEP

```java
Pattern<LoginEvent, ?> pattern = Pattern.<LoginEvent>begin("fail")
    .where(evt -> !evt.isSuccess())
    .times(3)
    .within(Time.minutes(1));

CEP.pattern(stream, pattern)
   .select((map) -> {
       alert("æ£€æµ‹åˆ°è¿ç»­ 3 æ¬¡ç™»å½•å¤±è´¥ï¼");
       return map;
   });
```

**ä¼˜åŠ¿ï¼š**
- âœ… å®æ—¶æ£€æµ‹ï¼ˆç¬¬ 2 æ¬¡å°±å¯ä»¥é¢„è­¦ï¼‰
- âœ… ä¸æŸ¥æ•°æ®åº“ï¼ˆå†…å­˜è®¡ç®—ï¼‰
- âœ… å»¶è¿Ÿ < 100ms

---

### 3.3 å®æ—¶æµé‡ç»Ÿè®¡ï¼ˆå¤§å±çœ‹æ¿ï¼‰

**éœ€æ±‚ï¼š** åŒåä¸€å¤§å±ï¼Œå®æ—¶æ˜¾ç¤ºæ¯ç§’è®¢å•é‡å’Œ GMV

#### âŒ æ–¹æ¡ˆ Aï¼šæ™®é€šç¨‹åº

```java
@Scheduled(fixedDelay = 1000)
public void updateDashboard() {
    String sql = "SELECT COUNT(*), SUM(amount) " +
                 "FROM orders " +
                 "WHERE create_time > NOW() - INTERVAL 1 SECOND";

    Map<String, Object> stats = jdbcTemplate.queryForMap(sql);
    sendToDashboard(stats);
}
```

**é—®é¢˜ï¼š**
- âŒ æ¯ç§’æ‰«æåƒä¸‡çº§è®¢å•è¡¨ï¼ˆæ•°æ®åº“çˆ†ç‚¸ï¼‰
- âŒ ç»Ÿè®¡å»¶è¿Ÿé«˜
- âŒ å¤§ä¿ƒæœŸé—´ç›´æ¥æŒ‚æ‰

#### âœ… æ–¹æ¡ˆ Bï¼šFlink

```java
DataStream<Order> stream = env
    .addSource(new KafkaSource(...))
    .window(TumblingProcessingTimeWindows.of(Time.seconds(1)))
    .aggregate(new CountAndSum());

stream.addSink(new DashboardSink());
```

**ä¼˜åŠ¿ï¼š**
- âœ… çœŸæ­£å®æ—¶ï¼ˆå»¶è¿Ÿ < 1 ç§’ï¼‰
- âœ… ä¸ä¾èµ–æ•°æ®åº“
- âœ… è‡ªåŠ¨æ‰©å±•

---

## 4. Flink vs æ™®é€šç¨‹åºå¯¹æ¯”

| åœºæ™¯ | æ™®é€šç¨‹åº | Flink |
|------|---------|-------|
| **å®æ—¶ç»Ÿè®¡** | âŒ æ¯æ¬¡æ‰«æå…¨è¡¨ | âœ… å¢é‡è®¡ç®— |
| **å¤æ‚äº‹ä»¶æ£€æµ‹** | âŒ éœ€è¦è‡ªå·±å®ç°çŠ¶æ€ç®¡ç† | âœ… å†…ç½® CEP |
| **æ•…éšœæ¢å¤** | âŒ å´©æºƒä¸¢å¤±æ•°æ® | âœ… è‡ªåŠ¨æ¢å¤ |
| **åˆ†å¸ƒå¼æ‰©å±•** | âŒ éš¾ä»¥å®ç° | âœ… åŠ æœºå™¨è‡ªåŠ¨æ‰©å±• |
| **å®æ—¶æ€§** | âŒ ç§’çº§å»¶è¿Ÿ | âœ… æ¯«ç§’çº§å»¶è¿Ÿ |
| **ååé‡** | âŒ ä¸‡çº§/ç§’ | âœ… ç™¾ä¸‡çº§/ç§’ |
| **å¼€å‘éš¾åº¦** | âœ… ç®€å• | âŒ å¤æ‚ |
| **èµ„æºæ¶ˆè€—** | âœ… ä½ | âŒ é«˜ |

---

## 5. æ•…éšœæ¢å¤æœºåˆ¶è¯¦è§£

### 5.1 ä»€ä¹ˆæ˜¯æ•…éšœæ¢å¤ï¼Ÿ

å½“ Flink ä»»åŠ¡å´©æºƒæˆ–æœºå™¨æ•…éšœæ—¶ï¼Œèƒ½å¤Ÿ**ä»æ–­ç‚¹ç»§ç»­å¤„ç†**ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€‚

---

### 5.2 Flink vs Kafka æ•…éšœæ¢å¤å¯¹æ¯”

| ç‰¹æ€§ | Kafka | Flink |
|------|-------|-------|
| **æŒä¹…åŒ–å†…å®¹** | æ¶ˆæ¯æ•°æ® | åº”ç”¨çŠ¶æ€ï¼ˆStateï¼‰ |
| **æŒä¹…åŒ–ä½ç½®** | ç£ç›˜æ—¥å¿—æ–‡ä»¶ | HDFS/S3/æœ¬åœ°ç£ç›˜ |
| **æ¢å¤æœºåˆ¶** | ä»ä¿å­˜çš„ offset é‡æ–°æ¶ˆè´¹ | ä» Checkpoint å¿«ç…§æ¢å¤ |
| **æ•°æ®æ¥æº** | æ¶ˆæ¯é˜Ÿåˆ—å†…éƒ¨ | åº”ç”¨ç¨‹åºçŠ¶æ€ |
| **ååŒå·¥ä½œ** | ä¿å­˜æ•°æ®æµ | è®°å½•å¤„ç†è¿›åº¦ |

**å…³é”®åŒºåˆ«ï¼š**
- **Kafka**ï¼šæŒä¹…åŒ–**æ¶ˆæ¯æœ¬èº«**ï¼ˆæ•°æ®æµï¼‰
- **Flink**ï¼šæŒä¹…åŒ–**å¤„ç†çŠ¶æ€**ï¼ˆåº”ç”¨ç¨‹åºçŠ¶æ€ï¼‰

---

### 5.3 Flink Checkpoint åŸç†

#### **æ ¸å¿ƒæ¦‚å¿µï¼šçŠ¶æ€å¿«ç…§**

```
Checkpoint = åº”ç”¨ç¨‹åºåœ¨æŸä¸€æ—¶åˆ»çš„çŠ¶æ€ç…§ç‰‡

å°±åƒç©æ¸¸æˆï¼š
- é—¯åˆ°ç¬¬ 5 å…³ â†’ ä¿å­˜æ¸¸æˆï¼ˆCheckpointï¼‰
- æŒ‚äº† â†’ è¯»å–å­˜æ¡£ â†’ ä»ç¬¬ 5 å…³ç»§ç»­
```

#### **Checkpoint æµç¨‹è¯¦è§£**

```
æ—¶é—´è½´ï¼š0--------10--------20--------30ç§’
        â†“         â†“         â†“         â†“
Checkpoint1  Checkpoint2  Checkpoint3

Checkpoint1ï¼ˆç¬¬ 10 ç§’ï¼‰ï¼š
- ä¿å­˜çŠ¶æ€ï¼šç”¨æˆ·Aè®¿é—®äº†5æ¬¡ï¼Œç”¨æˆ·Bè®¿é—®äº†3æ¬¡
- ä¿å­˜ Kafka åç§»é‡ï¼šå·²æ¶ˆè´¹åˆ°æ¶ˆæ¯1000

Checkpoint2ï¼ˆç¬¬ 20 ç§’ï¼‰ï¼š
- ä¿å­˜çŠ¶æ€ï¼šç”¨æˆ·Aè®¿é—®äº†8æ¬¡ï¼Œç”¨æˆ·Bè®¿é—®äº†6æ¬¡
- ä¿å­˜ Kafka åç§»é‡ï¼šå·²æ¶ˆè´¹åˆ°æ¶ˆæ¯2000

Checkpoint3ï¼ˆç¬¬ 30 ç§’ï¼‰ï¼š
- ä¿å­˜çŠ¶æ€ï¼šç”¨æˆ·Aè®¿é—®äº†12æ¬¡ï¼Œç”¨æˆ·Bè®¿é—®äº†9æ¬¡
- ä¿å­˜ Kafka åç§»é‡ï¼šå·²æ¶ˆè´¹åˆ°æ¶ˆæ¯3000
```

#### **æ•…éšœæ¢å¤æµç¨‹**

```
æ­£å¸¸è¿è¡Œï¼š
å¤„ç†æ¶ˆæ¯1-3000 â†’ ç¬¬30ç§’ Checkpoint3 â†’ ç»§ç»­å¤„ç†3001-4000
                                               â†“
                                            ä»»åŠ¡å´©æºƒ

æ¢å¤è¿‡ç¨‹ï¼š
1. æ‰¾åˆ°æœ€è¿‘çš„ Checkpointï¼ˆCheckpoint3ï¼‰
2. æ¢å¤çŠ¶æ€ï¼šç”¨æˆ·A=12æ¬¡ï¼Œç”¨æˆ·B=9æ¬¡
3. å‘Šè¯‰ Kafkaï¼šä»æ¶ˆæ¯3001 å¼€å§‹é‡æ–°å‘é€
4. é‡æ–°å¤„ç†æ¶ˆæ¯3001-4000
5. ç»§ç»­å¤„ç†4001...

âœ… ç»“æœï¼šæ¶ˆæ¯æ²¡æœ‰ä¸¢å¤±ï¼Œä¹Ÿæ²¡æœ‰é‡å¤å¤„ç†
```

---

### 5.4 Checkpoint å®ç°æœºåˆ¶

#### **ä¸¤é˜¶æ®µæäº¤ï¼ˆTwo-Phase Commitï¼‰**

Flink ä½¿ç”¨ **2PC** åè®®ç¡®ä¿ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼š

```
é˜¶æ®µ 1ï¼šé¢„æäº¤ï¼ˆPre-Commitï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flink å°†çŠ¶æ€å†™å…¥ä¸´æ—¶æ–‡ä»¶              â”‚
â”‚ Kafka å°†æ¶ˆæ¯æ ‡è®°ä¸º"æœªæäº¤"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ 2ï¼šæ­£å¼æäº¤ï¼ˆCommitï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flink ç¡®è®¤çŠ¶æ€å†™å…¥å®Œæˆ                â”‚
â”‚ Kafka å°†æ¶ˆæ¯æ ‡è®°ä¸º"å·²æäº¤"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¦‚æœé˜¶æ®µ 1 å¤±è´¥ï¼š
â†’ å›æ»šï¼Œä¸åšä»»ä½•æ›´æ”¹

å¦‚æœé˜¶æ®µ 2 ä¹‹å‰å´©æºƒï¼š
â†’ é‡å¯åä»ä¸Šä¸€ä¸ª Checkpoint æ¢å¤
â†’ ä¸´æ—¶æ–‡ä»¶è¢«æ¸…ç†ï¼Œä¸å½±å“ä¸€è‡´æ€§
```

---

### 5.5 Checkpoint é…ç½®ç¤ºä¾‹

**ClkLog é¡¹ç›®ä¸­çš„é…ç½®ï¼š**

```java
// å¯ç”¨ Checkpointï¼Œæ¯ 30 ç§’ä¸€æ¬¡
env.enableCheckpointing(30000);

// è®¾ç½®æ¨¡å¼ä¸ºç²¾ç¡®ä¸€æ¬¡
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);

// Checkpoint è¶…æ—¶æ—¶é—´ï¼ˆ10 åˆ†é’Ÿï¼‰
env.getCheckpointConfig().setCheckpointTimeout(600000);

// æœ€å°é—´éš”ï¼ˆ500 æ¯«ç§’ï¼‰
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(500);

// åŒæ—¶æœ€å¤šåªæœ‰ä¸€ä¸ª Checkpoint
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);

// å–æ¶ˆä»»åŠ¡æ—¶ä¿ç•™ Checkpoint
env.getCheckpointConfig().setExternalizedCheckpointCleanup(
    CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION
);

// Checkpoint å­˜å‚¨ä½ç½®
env.getCheckpointConfig().setCheckpointStorage(
    "file:///usr/local/services/clklogprocessing/checkpoints"
);

// è®¾ç½®çŠ¶æ€åç«¯
env.setStateBackend(new HashMapStateBackend());
```

---

### 5.6 Checkpoint vs Savepoint

| ç‰¹æ€§ | Checkpoint | Savepoint |
|------|-----------|-----------|
| **ç”¨é€”** | è‡ªåŠ¨æ•…éšœæ¢å¤ | æ‰‹åŠ¨å‡çº§/è¿ç§» |
| **è§¦å‘æ–¹å¼** | è‡ªåŠ¨ | æ‰‹åŠ¨ |
| **é¢‘ç‡** | é«˜é¢‘ï¼ˆç§’çº§/åˆ†é’Ÿçº§ï¼‰ | ä½é¢‘ï¼ˆæŒ‰éœ€ï¼‰ |
| **ç”Ÿå‘½å‘¨æœŸ** | ä»»åŠ¡å–æ¶ˆååˆ é™¤ | æ°¸ä¹…ä¿ç•™ |
| **å…¼å®¹æ€§** | å¯èƒ½ä¸å…¼å®¹è·¨ç‰ˆæœ¬ | è·¨ç‰ˆæœ¬å…¼å®¹ |

**ä¾‹å­ï¼š**
```
Checkpointï¼šæ¯30ç§’è‡ªåŠ¨ä¿å­˜ï¼Œç”¨äºè‡ªåŠ¨æ•…éšœæ¢å¤
Savepointï¼šå‡çº§ Flink ç‰ˆæœ¬å‰æ‰‹åŠ¨åˆ›å»ºï¼Œä¿å­˜ä»»åŠ¡çŠ¶æ€
```

---

## 6. å¢é‡æ›´æ–°åŸç†

### 6.1 ä»€ä¹ˆæ˜¯å¢é‡æ›´æ–°ï¼Ÿ

**å¢é‡æ›´æ–°** = åªå¤„ç†**æ–°æ¥çš„æ•°æ®**ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å¤„ç†**å…¨é‡æ•°æ®**ã€‚

---

### 6.2 å…¨é‡æ›´æ–° vs å¢é‡æ›´æ–°

#### **å…¨é‡æ›´æ–°ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰**

```
é—®é¢˜ï¼šç»Ÿè®¡ä»Šå¤©çš„æ€»è®¢å•æ•°

æ¯æ¬¡æŸ¥è¯¢ï¼š
SELECT COUNT(*) FROM orders WHERE date = '2025-12-31'

é—®é¢˜ï¼š
- æ¯æ¬¡æ‰«æ 100 ä¸‡æ¡è®¢å•ï¼ˆæ…¢ï¼‰
- æ•°æ®é‡è¶Šå¤§è¶Šæ…¢
- æµªè´¹è®¡ç®—èµ„æº
```

#### **å¢é‡æ›´æ–°ï¼ˆæµå¤„ç†ï¼‰**

```
æ—¶é—´è½´ï¼š0ç‚¹    10ç‚¹    20ç‚¹    24ç‚¹
       â†“      â†“      â†“      â†“
è®¢å•æ•°ï¼š  0  â†’ 10ä¸‡  â†’ 50ä¸‡  â†’ 100ä¸‡

å¢é‡è®¡ç®—ï¼š
10ç‚¹æ—¶ï¼šåªè®¡ç®— 0-10ç‚¹çš„æ–°è®¢å•ï¼ˆ10ä¸‡æ¡ï¼‰
20ç‚¹æ—¶ï¼šåªè®¡ç®— 10-20ç‚¹çš„æ–°è®¢å•ï¼ˆ40ä¸‡æ¡ï¼‰
24ç‚¹æ—¶ï¼šåªè®¡ç®— 20-24ç‚¹çš„æ–°è®¢å•ï¼ˆ50ä¸‡æ¡ï¼‰

æ¯æ¬¡åªå¤„ç†æ–°å¢æ•°æ®ï¼Œä¸é‡å¤è®¡ç®—å†å²æ•°æ®
```

---

### 6.3 å¢é‡æ›´æ–°å®ç°åŸç†

#### **æ–¹æ³• 1ï¼šåŸºäºæ—¶é—´çª—å£ï¼ˆFlinkï¼‰**

```java
// æ»šåŠ¨çª—å£ï¼Œæ¯ 5 åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡
stream
    .window(TumblingProcessingTimeWindows.of(Time.minutes(5)))
    .aggregate(new Counter());

// çª—å£ 1: 0:00-0:05ï¼Œå¤„ç†è¿™ 5 åˆ†é’Ÿçš„æ•°æ®
// çª—å£ 2: 0:05-0:10ï¼Œå¤„ç†è¿™ 5 åˆ†é’Ÿçš„æ•°æ®
// ...
// æ¯ä¸ªçª—å£çš„æ•°æ®åªå¤„ç†ä¸€æ¬¡
```

#### **æ–¹æ³• 2ï¼šåŸºäºçŠ¶æ€ç»´æŠ¤**

```java
// ä¿å­˜å½“å‰çš„æ€»è®¡æ•°
ValueState<Long> totalCount;

// æ¥ä¸€æ¡æ–°æ•°æ®ï¼Œæ›´æ–°è®¡æ•°
public void processElement(Order order, Context ctx, Collector<Result> out) {
    Long current = totalCount.value();  // è¯»å–å½“å‰å€¼
    if (current == null) {
        current = 0L;
    }
    current += order.getAmount();        // å¢é‡æ›´æ–°
    totalCount.update(current);          // ä¿å­˜æ–°å€¼
    out.collect(new Result(current));
}

// å†…å­˜ä¸­åªä¿å­˜ä¸€ä¸ªæ•°å­—ï¼ˆå½“å‰æ€»æ•°ï¼‰
// ä¸éœ€è¦é‡æ–°æ‰«ææ‰€æœ‰å†å²è®¢å•
```

---

### 6.4 å¢é‡æ›´æ–°çš„æ•°æ®æ¥æº

#### **æ•°æ®æµå¤„ç†ï¼ˆFlinkï¼‰**

```
æ•°æ®æ¥æºï¼šå®æ—¶æ•°æ®æµï¼ˆKafkaã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
                    â†“
            åªå¤„ç†æ–°æµè¿‡çš„æ•°æ®
                    â†“
        ä¸éœ€è¦è®¿é—®å†å²æ•°æ®å­˜å‚¨
```

**ç‰¹ç‚¹ï¼š**
- âœ… æ•°æ®è‡ªç„¶æœ‰åºï¼ˆæŒ‰æ—¶é—´æµè¿‡ï¼‰
- âœ… è‡ªåŠ¨å¢é‡ï¼ˆå¤„ç†è¿‡çš„æ•°æ®ä¸ä¼šå†æµè¿‡æ¥ï¼‰
- âœ… ä¸éœ€è¦å…¨é‡å­˜å‚¨

**ä¾‹å­ï¼š**
```java
// ä» Kafka å®æ—¶æ¶ˆè´¹è®¢å•
KafkaSource<Order> source = ...;

// Kafka è‡ªåŠ¨ç®¡ç†åç§»é‡
// å·²æ¶ˆè´¹çš„æ¶ˆæ¯ä¸ä¼šå†æ¬¡æ¶ˆè´¹
// å¤©ç„¶å¢é‡
```

---

#### **æ‰¹å¤„ç†ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰**

```
æ•°æ®æ¥æºï¼šæ•°æ®åº“/æ•°æ®ä»“åº“
                    â†“
         è®°å½•ä¸Šæ¬¡å¤„ç†çš„ä½ç½®ï¼ˆoffsetï¼‰
                    â†“
    æ¯æ¬¡åªè¯»å– offset ä¹‹åçš„æ–°æ•°æ®
```

**ä¾‹å­ï¼š**
```java
// è®°å½•ä¸Šæ¬¡å¤„ç†çš„æ—¶é—´
String lastProcessTime = loadLastProcessTime(); // "2025-12-31 10:00:00"

// åªæŸ¥è¯¢è¿™ä¸ªæ—¶é—´ä¹‹åçš„æ•°æ®
String sql = "SELECT * FROM orders " +
             "WHERE create_time > ? " +           // å¢é‡æŸ¥è¯¢
             "ORDER BY create_time";

List<Order> newOrders = jdbcTemplate.query(sql, lastProcessTime);

// æ›´æ–°å¤„ç†æ—¶é—´
saveLastProcessTime("2025-12-31 11:00:00");
```

---

### 6.5 å¢é‡æ›´æ–°çš„ä¼˜åŠ¿

| æŒ‡æ ‡ | å…¨é‡æ›´æ–° | å¢é‡æ›´æ–° |
|------|---------|---------|
| **è®¡ç®—é‡** | æ¯æ¬¡å¤„ç† 100 ä¸‡æ¡ | æ¯æ¬¡å¤„ç† 1 ä¸‡æ¡ |
| **å»¶è¿Ÿ** | ç§’çº§/åˆ†é’Ÿçº§ | æ¯«ç§’çº§ |
| **èµ„æºæ¶ˆè€—** | é«˜ï¼ˆCPU/IOï¼‰ | ä½ |
| **å®æ—¶æ€§** | å·® | ä¼˜ |
| **å­˜å‚¨ä¾èµ–** | éœ€è¦ï¼ˆä¿å­˜å…¨é‡ï¼‰ | ä¸éœ€è¦ï¼ˆæµè¿‡å³å¯ï¼‰ |

---

### 6.6 å¢é‡æ›´æ–°çš„å…¸å‹åº”ç”¨

#### **1. å®æ—¶ç»Ÿè®¡å¤§å±**

```
éœ€æ±‚ï¼šæ˜¾ç¤ºä»Šæ—¥å®æ—¶è®¢å•é‡

å…¨é‡æ–¹å¼ï¼š
æ¯æ¬¡éƒ½æ‰§è¡Œï¼šSELECT COUNT(*) FROM orders WHERE date = today
â†’ æ‰«æ 100 ä¸‡æ¡è®°å½•

å¢é‡æ–¹å¼ï¼š
åˆå§‹åŒ–ï¼šcount = 0
æ¯æ¥ä¸€ä¸ªè®¢å•ï¼šcount = count + 1
â†’ åªåšåŠ æ³•ï¼Œä¸æŸ¥æ•°æ®åº“
```

#### **2. ç”¨æˆ·è¡Œä¸ºåˆ†æ**

```
éœ€æ±‚ï¼šç»Ÿè®¡ç”¨æˆ·æœ€è¿‘ 1 å°æ—¶çš„ç‚¹å‡»é‡

å…¨é‡æ–¹å¼ï¼š
æ¯æ¬¡éƒ½æŸ¥è¯¢ç”¨æˆ·æœ€è¿‘ 1 å°æ—¶çš„æ‰€æœ‰ç‚¹å‡»è®°å½•
â†’ é‡å¤è®¡ç®—

å¢é‡æ–¹å¼ï¼š
ä½¿ç”¨æ»‘åŠ¨çª—å£ï¼Œåªå¤„ç†æ–°æ¥çš„ç‚¹å‡»äº‹ä»¶
â†’ æ¯ä¸ªäº‹ä»¶åªè®¡ç®—ä¸€æ¬¡
```

#### **3. å®æ—¶æ¨è**

```
éœ€æ±‚ï¼šæ ¹æ®ç”¨æˆ·æœ€è¿‘è¡Œä¸ºæ›´æ–°æ¨è

å…¨é‡æ–¹å¼ï¼š
æ¯æ¬¡éƒ½æ‰«æç”¨æˆ·æ‰€æœ‰å†å²è¡Œä¸ºï¼ˆ10000 æ¡ï¼‰
â†’ è®¡ç®—æ…¢

å¢é‡æ–¹å¼ï¼š
åªå¤„ç†æ–°çš„è¡Œä¸ºäº‹ä»¶ï¼Œæ›´æ–°ç”¨æˆ·ç‰¹å¾
â†’ å®æ—¶å¿«
```

---

## 7. ClkLog é¡¹ç›®ä¸­çš„ Flink åˆ†æ

### 7.1 ClkLog ä¸­ Flink çš„å®é™…ä½œç”¨

**æ–‡ä»¶ï¼š** `JieXiJson.java`

```java
// 1. ä» Kafka æ¶ˆè´¹åŸå§‹æ—¥å¿—
KafkaSource<String> kafkaSource = KafkaSource.<String>builder()
    .setTopics("clklog")
    .build();

DataStreamSource<String> streamSource = env.fromSource(kafkaSource, ...);

// 2. è§£æ JSON æ•°æ®
SingleOutputStreamOperator<LogBeanCollection> value = streamSource
    .map(new LogRichMapper());  // è§£æ + IP åœ°ç†ä½ç½® + User-Agent

// 3. æ—¶é—´çª—å£ï¼ˆ10 ç§’ï¼‰
SingleOutputStreamOperator<List<LogBeanCollection>> valueInWindow = value
    .windowAll(TumblingProcessingTimeWindows.of(Time.seconds(10)))
    .apply(...);  // æ”¶é›† 10 ç§’çš„æ•°æ®

// 4. æ‰¹é‡å†™å…¥ ClickHouse
valueInWindow.addSink(new LogAnalysisClickHouseSink());
```

---

### 7.2 ClkLog ä¸­ Flink åšäº†ä»€ä¹ˆï¼Ÿ

| åŠŸèƒ½ | è¯´æ˜ | æ˜¯å¦æ ¸å¿ƒ Flink èƒ½åŠ› |
|------|------|-------------------|
| **ä» Kafka æ¶ˆè´¹** | è¯»å–æ¶ˆæ¯é˜Ÿåˆ— | âŒ æ™®é€šç¨‹åºä¹Ÿèƒ½åš |
| **è§£æ JSON** | æå–å­—æ®µ | âŒ æ™®é€šç¨‹åºä¹Ÿèƒ½åš |
| **IP åœ°ç†ä½ç½®è§£æ** | æŸ¥è¯¢ IP åº“ | âŒ æ™®é€šç¨‹åºä¹Ÿèƒ½åš |
| **User-Agent è§£æ** | è§£ææµè§ˆå™¨/è®¾å¤‡ | âŒ æ™®é€šç¨‹åºä¹Ÿèƒ½åš |
| **æ—¶é—´çª—å£ï¼ˆ10ç§’ï¼‰** | æ‰¹é‡å¤„ç† | âš ï¸  ç®€å•èšåˆ |
| **æ‰¹é‡å†™å…¥ ClickHouse** | æå‡æ€§èƒ½ | âŒ æ™®é€šç¨‹åºä¹Ÿèƒ½åš |
| **Checkpoint å®¹é”™** | æ•…éšœæ¢å¤ | âœ… æ ¸å¿ƒèƒ½åŠ› |

---

### 7.3 ç»“è®ºï¼šFlink è¢«å¤§æå°ç”¨äº†

**ClkLog ä¸­çš„ Flink ç”¨æ³•ï¼š**
- âŒ **æ²¡æœ‰ç”¨** çª—å£èšåˆç»Ÿè®¡
- âŒ **æ²¡æœ‰ç”¨** å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰
- âŒ **æ²¡æœ‰ç”¨** çŠ¶æ€è®¡ç®—
- âœ… **åªç”¨äº†è§£æ + æ‰¹é‡å†™å…¥ + Checkpoint**

**ç±»æ¯”ï¼š**
- ç”¨æ³•æ‹‰åˆ©é€å¤–å–ï¼ˆèƒ½é€ï¼Œä½†æµªè´¹ï¼‰
- ç”¨å¤§ç‚®æ‰“èšŠå­ï¼ˆèƒ½æ‰“æ­»ï¼Œä½†æ²¡å¿…è¦ï¼‰

---

## 8. æ˜¯å¦éœ€è¦ä½¿ç”¨ Flink

### 8.1 å†³ç­–æ ‘

```
ä½ çš„æ•°æ®é‡æ˜¯å¤šå°‘ï¼Ÿ
â”‚
â”œâ”€ < 10 ä¸‡/å¤©
â”‚   â””â”€ âŒ ä¸éœ€è¦ Flinkï¼ˆå•æœºç¨‹åºè¶³å¤Ÿï¼‰
â”‚
â”œâ”€ 10-100 ä¸‡/å¤©
â”‚   â””â”€ âŒ ä¸éœ€è¦ Flinkï¼ˆç®€å•æ¶ˆè´¹è€…ç¨‹åºï¼‰
â”‚
â”œâ”€ 100-1000 ä¸‡/å¤©
â”‚   â””â”€ âš ï¸  å¯é€‰ï¼ˆçœ‹å…·ä½“éœ€æ±‚ï¼‰
â”‚
â””â”€ > 1000 ä¸‡/å¤©
    â””â”€ âœ… å»ºè®®ä½¿ç”¨ Flink

ä½ éœ€è¦å®æ—¶èšåˆå—ï¼Ÿ
â”‚
â”œâ”€ å¦ï¼ˆåªéœ€è¦å­˜å‚¨åŸå§‹æ•°æ®ï¼‰
â”‚   â””â”€ âŒ ä¸éœ€è¦ Flink
â”‚
â””â”€ æ˜¯ï¼ˆéœ€è¦å®æ—¶ç»Ÿè®¡ã€çª—å£èšåˆï¼‰
    â””â”€ âœ… éœ€è¦ Flink

ä½ éœ€è¦å¤æ‚äº‹ä»¶å¤„ç†å—ï¼Ÿ
â”‚
â”œâ”€ å¦ï¼ˆç®€å•çš„è¿‡æ»¤ã€è½¬æ¢ï¼‰
â”‚   â””â”€ âŒ ä¸éœ€è¦ Flink
â”‚
â””â”€ æ˜¯ï¼ˆæ£€æµ‹å¤æ‚æ¨¡å¼ã€åºåˆ—ï¼‰
    â””â”€ âœ… éœ€è¦ Flink
```

---

### 8.2 æ›¿ä»£æ–¹æ¡ˆï¼šè‡ªå·±å†™æ¶ˆè´¹è€…ç¨‹åº

**é€‚ç”¨åœºæ™¯ï¼š**
- æ—¥å‡ < 100 ä¸‡æ¡æ•°æ®
- ä¸éœ€è¦å®æ—¶èšåˆ
- åªéœ€è¦å­˜å‚¨åŸå§‹æ•°æ®

**ä»£ç æ¡†æ¶ï¼ˆ200 è¡Œæå®šï¼‰ï¼š**

```java
@Component
public class LogProcessor {

    @Autowired
    private JdbcTemplate clickHouseTemplate;

    @Autowired
    private StringRedisTemplate redisTemplate;

    private final Queue<LogBean> buffer = new ConcurrentLinkedQueue<>();

    // 1. ä» Redis é˜Ÿåˆ—æ¶ˆè´¹
    @Scheduled(fixedDelay = 100)
    public void consumeFromRedis() {
        String logData = redisTemplate.opsForList().rightPop("clklog:queue");
        if (logData != null) {
            LogBean logBean = parseLog(logData);
            buffer.offer(logBean);
        }
    }

    // 2. è§£ææ—¥å¿—
    private LogBean parseLog(String line) {
        // JSON è§£æ
        JsonNode json = objectMapper.readTree(line);
        LogBean logBean = new LogBean();
        logBean.setEvent(json.get("event").asText());
        // ... å…¶ä»–å­—æ®µ

        // User-Agent è§£æ
        UserAgent ua = userAgentAnalyzer.parse(logBean.getUserAgent());

        // IP åœ°ç†ä½ç½®è§£æ
        Region region = parseIpRegion(logBean.getClientIp());

        return logBean;
    }

    // 3. æ‰¹é‡å†™å…¥ ClickHouseï¼ˆæ¯ 10 ç§’ï¼‰
    @Scheduled(fixedDelay = 10000)
    public void batchWriteToClickHouse() {
        if (buffer.isEmpty()) return;

        List<LogBean> batch = new ArrayList<>();
        LogBean bean;
        while ((bean = buffer.poll()) != null && batch.size() < 1000) {
            batch.add(bean);
        }

        // æ‰¹é‡æ’å…¥
        String sql = "INSERT INTO log_analysis (...) VALUES (...)";
        clickHouseTemplate.batchUpdate(sql, batch);
    }
}
```

**èµ„æºå¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | CPU | å†…å­˜ | ååé‡ |
|------|-----|------|--------|
| **Flink** | 5 æ ¸ | 10 GB | 10000 æ¡/ç§’ |
| **è‡ªå·±å†™** | 1 æ ¸ | 1 GB | 2000 æ¡/ç§’ |

---

### 8.3 æœ€ç»ˆå»ºè®®

#### **å»æ‰ Flinkï¼Œè‡ªå·±å†™ï¼Œå¦‚æœï¼š**

âœ… æ•°æ®é‡ < 100 ä¸‡/å¤©
âœ… ä¸éœ€è¦å®æ—¶èšåˆç»Ÿè®¡
âœ… ä¸éœ€è¦å¤æ‚äº‹ä»¶å¤„ç†
âœ… èµ„æºæœ‰é™
âœ… æƒ³é™ä½ç³»ç»Ÿå¤æ‚åº¦

**ä¼˜åŠ¿ï¼š**
- èŠ‚çœ 9 GB å†…å­˜
- èŠ‚çœ 4 æ ¸ CPU
- ä»£ç æ›´ç®€å•
- æ›´å®¹æ˜“ç»´æŠ¤

#### **ä¿ç•™ Flinkï¼Œå¦‚æœï¼š**

âœ… æ•°æ®é‡ > 500 ä¸‡/å¤©
âœ… éœ€è¦å®æ—¶èšåˆç»Ÿè®¡
âœ… éœ€è¦å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰
âœ… éœ€è¦ä¸¥æ ¼çš„æ•…éšœæ¢å¤
âœ… æœªæ¥å¯èƒ½æ‰©å±•

---

## ğŸ“š æ€»ç»“

### Flink çš„æ ¸å¿ƒä»·å€¼

1. **æœ‰çŠ¶æ€æµå¤„ç†** - è®°ä½å†å²æ•°æ®
2. **çª—å£è®¡ç®—** - çµæ´»çš„æ—¶é—´èšåˆ
3. **ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰** - æ•°æ®ä¸é‡ä¸æ¼
4. **åˆ†å¸ƒå¼æ‰§è¡Œ** - æ°´å¹³æ‰©å±•
5. **å¤æ‚äº‹ä»¶å¤„ç†** - æ£€æµ‹å¤æ‚æ¨¡å¼

### ä»€ä¹ˆæ—¶å€™éœ€è¦ Flinkï¼Ÿ

- âœ… å¤§è§„æ¨¡æ•°æ®ï¼ˆ> 500 ä¸‡/å¤©ï¼‰
- âœ… å¤æ‚å®æ—¶è®¡ç®—ï¼ˆçª—å£ã€èšåˆã€CEPï¼‰
- âœ… ä¸¥æ ¼å¯é æ€§è¦æ±‚

### ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦ Flinkï¼Ÿ

- âŒ ç®€å•çš„ ETLï¼ˆè¯»å– â†’ è§£æ â†’ å†™å…¥ï¼‰
- âŒ æ•°æ®é‡ä¸å¤§ï¼ˆ< 100 ä¸‡/å¤©ï¼‰
- âŒ åªéœ€è¦å­˜å‚¨åŸå§‹æ•°æ®

### ClkLog é¡¹ç›®çš„ç»“è®º

**Flink åœ¨ ClkLog ä¸­è¢«å¤§æå°ç”¨äº†ï¼**

å»ºè®®å»æ‰ Flink + Kafkaï¼Œæ”¹ç”¨ç®€å•çš„æ¶ˆè´¹è€…ç¨‹åºï¼š
- èŠ‚çœ 80% çš„èµ„æº
- é™ä½ 90% çš„å¤æ‚åº¦
- åŠŸèƒ½å®Œå…¨ä¸€æ ·

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æ›´æ–°æ—¶é—´ï¼š** 2025-12-31
**ä½œè€…ï¼š** Claude
